{% extends 'submissions/base.html' %}

{% block title %}–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–∞–π–ª—É{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-2 sticky-top" style="z-index: 1000;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-secondary btn-sm me-3">
                                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                            </a>
                            <span class="fs-5">
                                {% if file_type == 'code' %}üíª{% else %}üìÑ{% endif %}
                            </span>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            {% if prev_submission %}
                            <a href="{% url 'view_file' prev_submission.id %}" class="btn btn-outline-primary btn-sm"
                                title="–ü–æ–ø–µ—Ä–µ–¥–Ω—è —Ä–æ–±–æ—Ç–∞">
                                <i class="bi bi-chevron-left"></i> –ü–æ–ø–µ—Ä–µ–¥–Ω—è
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled><i class="bi bi-chevron-left"></i>
                                –ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
                            {% endif %}

                            {% if next_submission %}
                            <a href="{% url 'view_file' next_submission.id %}" class="btn btn-outline-primary btn-sm"
                                title="–ù–∞—Å—Ç—É–ø–Ω–∞ —Ä–æ–±–æ—Ç–∞">
                                –ù–∞—Å—Ç—É–ø–Ω–∞ <i class="bi bi-chevron-right"></i>
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled>–ù–∞—Å—Ç—É–ø–Ω–∞ <i
                                    class="bi bi-chevron-right"></i></button>
                            {% endif %}

                            {% if submission.link %}
                            <a href="{{ submission.link }}" target="_blank" class="btn btn-primary btn-sm ms-2">
                                <i class="bi bi-box-arrow-up-right"></i> –ü–µ—Ä–µ–π—Ç–∏
                            </a>
                            {% elif submission.file %}
                            <a href="{{ submission.file.url }}" download class="btn btn-primary btn-sm ms-2">
                                <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- File Info Block -->
                <div class="bg-light border-bottom px-4 py-3">
                    <h5 class="mb-1 fw-bold text-break">{{ file_name }}</h5>
                    <div class="text-muted small">
                        <i class="bi bi-person me-1"></i>{{ submission.last_name }} {{ submission.first_name }}
                        <span class="mx-2">|</span>
                        <i class="bi bi-people me-1"></i>{{ submission.class_group.name }}
                    </div>
                </div>

                <!-- Formula Bar for Excel -->
                {% if file_ext == '.xlsx' or file_ext == '.ods' %}
                <div class="formula-bar p-2 bg-light border-bottom d-flex align-items-center">
                    <span class="text-muted me-2 fw-bold">fx</span>
                    <input type="text" id="formula-input" class="form-control form-control-sm bg-white" readonly
                        placeholder="–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–º—ñ—Ä–∫—É...">
                </div>
                {% endif %}

                <div class="card-body p-0 bg-light">
                    {% if file_type == 'code' %}
                    <!-- Code Viewer -->
                    <div style="background-color: #282c34; min-height: 500px; padding: 1rem;">
                        <pre class="m-0"
                            style="border-radius: 0;"><code class="language-{{ file_ext|slice:'1:' }}">{{ content }}</code></pre>
                    </div>

                    {% elif file_type == 'office_preview' %}
                    <!-- Office Document Preview -->
                    <div class="office-preview-container p-4" style="overflow-x: auto;">
                        {% if error_message %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>{{ error_message }}
                        </div>
                        <div class="text-center mt-4">
                            <a href="{{ submission.file.url }}" download class="btn btn-primary btn-lg">
                                <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
                            </a>
                        </div>
                        {% endif %}

                        {% if html_content %}
                        {{ html_content|safe }}
                        {% endif %}
                    </div>

                    {% elif file_type == 'archive' %}
                    <!-- Archive Preview -->
                    <div class="archive-preview p-4">
                        {% if error_message %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>{{ error_message }}
                        </div>
                        {% endif %}

                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-archive me-2"></i>–í–º—ñ—Å—Ç –∞—Ä—Ö—ñ–≤—É</h5>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for file in archive_content %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if file.is_dir %}
                                        <i class="bi bi-folder-fill text-warning me-2"></i>
                                        {% else %}
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        {% endif %}
                                        {{ file.name }}
                                    </div>
                                    <span class="badge bg-light text-dark">{{ file.size|filesizeformat }}</span>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-muted">–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <a href="{{ submission.file.url }}" download class="btn btn-primary">
                                <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—Ä—Ö—ñ–≤
                            </a>
                        </div>
                    </div>

                    {% elif file_type == 'image' %}
                    <!-- Image Preview -->
                    <div class="image-preview-container p-4 text-center bg-dark">
                        <img src="{{ submission.file.url }}" class="img-fluid shadow-sm"
                            style="max-height: 80vh; border-radius: 4px;" alt="{{ file_name }}">

                        <div class="mt-4">
                            <a href="{{ submission.file.url }}" download class="btn btn-primary">
                                <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                            </a>
                        </div>
                    </div>

                    {% elif file_type == 'pdf' %}
                    <!-- PDF Preview -->
                    <div class="pdf-preview-container bg-dark" style="height: 80vh;">
                        <object data="{{ submission.file.url }}" type="application/pdf" width="100%" height="100%">
                            <div class="text-center text-white pt-5">
                                <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤–±—É–¥–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ PDF.</p>
                                <a href="{{ submission.file.url }}" class="btn btn-primary">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</a>
                            </div>
                        </object>
                    </div>

                    {% elif file_type == 'link' %}
                    <!-- Link Preview -->
                    <div class="link-preview-container bg-light h-100 d-flex flex-column">
                        <div class="p-2 bg-white border-bottom d-flex justify-content-between align-items-center">
                            <a href="{{ submission.link }}" target="_blank" class="text-truncate me-3">
                                <i class="bi bi-link-45deg me-1"></i>{{ submission.link }}
                            </a>
                            <a href="{{ submission.link }}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-box-arrow-up-right me-1"></i>–í—ñ–¥–∫—Ä–∏—Ç–∏
                            </a>
                        </div>
                        <div class="flex-grow-1 bg-white position-relative">
                            <iframe src="{{ submission.link }}" width="100%" height="100%"
                                style="border: none; min-height: 80vh;">
                                <div class="text-center p-5">
                                    <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ —Ü—å–æ–≥–æ —Å–∞–π—Ç—É.</p>
                                    <a href="{{ submission.link }}" target="_blank" class="btn btn-primary">–í—ñ–¥–∫—Ä–∏—Ç–∏
                                        —Å–∞–π—Ç</a>
                                </div>
                            </iframe>
                            <!-- Overlay for sites that block embedding -->
                            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-light bg-opacity-75"
                                style="z-index: -1;" id="iframe-fallback">
                                <div class="text-center">
                                    <p class="mb-3">–Ø–∫—â–æ —Å–∞–π—Ç –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è, –º–æ–∂–ª–∏–≤–æ –≤—ñ–Ω –∑–∞–±–æ—Ä–æ–Ω—è—î –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è.</p>
                                    <a href="{{ submission.link }}" target="_blank" class="btn btn-primary">
                                        <i class="bi bi-box-arrow-up-right me-2"></i>–í—ñ–¥–∫—Ä–∏—Ç–∏ —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif file_type == 'office' %}
                    <!-- Office Document Placeholder -->
                    <div class="text-center p-5">
                        <div class="mb-4">
                            {% if file_ext == '.docx' or file_ext == '.doc' %}
                            <div class="display-1 text-primary mb-3">üìù</div>
                            <h4>Word –¥–æ–∫—É–º–µ–Ω—Ç</h4>
                            {% elif file_ext == '.xlsx' or file_ext == '.xls' %}
                            <div class="display-1 text-success mb-3">üìä</div>
                            <h4>Excel —Ç–∞–±–ª–∏—Ü—è</h4>
                            {% elif file_ext == '.pptx' or file_ext == '.ppt' %}
                            <div class="display-1 text-warning mb-3">üìΩÔ∏è</div>
                            <h4>PowerPoint –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è</h4>
                            {% endif %}
                        </div>

                        <div class="alert alert-info d-inline-block text-start">
                            <strong>‚ÑπÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ Office</strong><br>
                            –î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Å–≤—ñ–π –∫–æ–º–ø'—é—Ç–µ—Ä.
                        </div>

                        <div class="mt-4">
                            <a href="{{ submission.file.url }}" download class="btn btn-primary btn-lg">
                                <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
                            </a>
                        </div>

                        <div class="mt-4">
                            <small class="text-muted">–†–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É: {{ submission.file.size|filesizeformat }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar (Grading) -->
        <div class="col-md-3">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-white">
                    <h5 class="mb-0">–û—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è</h5>
                </div>
                <div class="card-body">
                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <form method="post" id="grade-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="grade">
                        <div class="mb-3">
                            <label for="grade" class="form-label">–û—Ü—ñ–Ω–∫–∞</label>
                            <input type="number" class="form-control" id="grade" name="grade"
                                value="{{ submission.grade }}" min="1" max="12" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">–ó–±–µ—Ä–µ–≥—Ç–∏ –æ—Ü—ñ–Ω–∫—É</button>
                        </div>
                    </form>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label text-muted small">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</label>
                        <ul class="list-unstyled small">
                            <li class="mb-2">
                                <i class="bi bi-calendar me-2"></i>{{ submission.submitted_at|date:"d.m.Y H:i" }}
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-person me-2"></i>{{ submission.last_name }} {{ submission.first_name }}
                            </li>
                            <li><i class="bi bi-people me-2"></i>{{ submission.class_group.name }}</li>
                        </ul>
                    </div>

                    <hr>

                    <!-- Comments Section -->
                    <!-- Comments Section -->
                    <div class="mb-3">
                        <label class="form-label text-muted small">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</label>
                        <div id="comments-list" class="mb-3" style="max-height: 250px; overflow-y: auto;">
                            {% for comment in comments %}
                            <div class="comment-item bg-light p-2 rounded mb-2" data-comment-id="{{ comment.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <small class="text-muted">
                                            üìÖ {{ comment.created_at|date:"d.m.Y H:i" }} |

                                            üë§ {% if comment.author.first_name %}
                                            {{ comment.author.first_name }}
                                            {{ comment.author.last_name }}{% else %}{{ comment.author.username }}
                                            {% endif %}
                                        </small>
                                        <div class="mt-1" style="white-space: pre-wrap;">{{ comment.text }}</div>
                                    </div>
                                    {% if comment.author == request.user or request.user.is_staff %}
                                    <button class="btn btn-sm btn-outline-danger delete-comment-btn ms-2"
                                        data-comment-id="{{ comment.id }}" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted small">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.</p>
                            {% endfor %}
                        </div>
                    </div>


                    <form id="comment-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="comment">
                        <div class="mb-3">
                            <textarea class="form-control" id="comment-input" name="comment" rows="2"
                                placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –Ω–æ–≤–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit"
                                class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center gap-2">
                                <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</span>
                                <div class="spinner-border spinner-border-sm d-none" role="status"></div>
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prism.js for Syntax Highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

<script>
    // Excel Formula Bar Logic
    function showFormula(cell) {
        const formulaInput = document.getElementById('formula-input');
        if (formulaInput) {
            const formula = cell.getAttribute('data-formula');
            formulaInput.value = formula || cell.innerText;
            document.querySelectorAll('.excel-table td').forEach(td => td.classList.remove('active-cell'));
            cell.classList.add('active-cell');
        }
    }

    // Comment AJAX Logic
    document.addEventListener('DOMContentLoaded', function () {
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.getElementById('comments-list');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Add comment
        if (commentForm) {
            commentForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const btn = this.querySelector('button[type="submit"]');
                const spinner = btn.querySelector('.spinner-border');
                const icon = btn.querySelector('.bi-send');
                const textarea = this.querySelector('textarea');
                const comment = textarea.value.trim();

                if (!comment) return;

                // Animation start
                btn.disabled = true;
                spinner.classList.remove('d-none');
                icon.classList.add('d-none');

                const formData = new FormData(this);

                fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Create new comment element
                            const commentHTML = `
                            <div class="comment-item bg-light p-2 rounded mb-2" data-comment-id="${data.comment.id}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <small class="text-muted">
                                            üìÖ ${data.comment.created_at} | üë§ ${data.comment.author}
                                        </small>
                                        <div class="mt-1" style="white-space: pre-wrap;">${data.comment.text}</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger delete-comment-btn ms-2" data-comment-id="${data.comment.id}" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;

                            // Remove "no comments" message if exists
                            const noComments = commentsList.querySelector('.text-muted');
                            if (noComments) noComments.remove();

                            // Add new comment
                            commentsList.insertAdjacentHTML('beforeend', commentHTML);
                            commentsList.scrollTop = commentsList.scrollHeight;

                            // Clear input
                            textarea.value = '';

                            // Success animation
                            btn.querySelector('span').textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');

                            setTimeout(() => {
                                btn.querySelector('span').textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏';
                                btn.classList.remove('btn-success');
                                btn.classList.add('btn-outline-primary');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                    })
                    .finally(() => {
                        btn.disabled = false;
                        spinner.classList.add('d-none');
                        icon.classList.remove('d-none');
                    });
            });
        }

        // Delete comment
        document.addEventListener('click', function (e) {
            if (e.target.closest('.delete-comment-btn')) {
                const btn = e.target.closest('.delete-comment-btn');
                const commentId = btn.dataset.commentId;

                if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä?')) return;

                fetch(`/teacher/comment/delete/${commentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
                            commentItem.remove();

                            // Show "no comments" if list is empty
                            if (commentsList.children.length === 0) {
                                commentsList.innerHTML = '<p class="text-muted small">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.</p>';
                            }
                        } else {
                            alert(data.message || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
                    });
            }
        });
    });
</script>
{% endblock %}